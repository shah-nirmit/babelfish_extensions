name: Cache Build Artifacts
on: [push, pull_request]

jobs:
  run-babelfish-jdbc-tests:
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@v2
        id: checkout

      - name: Install Dependencies
        id: install-dependencies
        if: always()
        uses: ./.github/composite-actions/install-dependencies

      - name: Restore ccache
        id: cache-compiler
        uses: actions/cache@v3
        with:
          path: ~/.ccache
          key: ccache-Jumbo
          restore-keys: |
            ccache-Jumbo

      - name: Clone, build, and run tests for Postgres engine using ${{ inputs.engine_branch }}
        id: build-modified-postgres
        uses: ./.github/composite-actions/build-modified-postgres
        if: always() && steps.install-dependencies.outcome == 'success'
        with:
          engine_branch: BABEL_1_2_STABLE__PG_13_6
          install_dir: psql13

      - name: Compile ANTLR
        id: compile-antlr
        if: always() && steps.build-modified-postgres.outcome == 'success'
        uses: ./.github/composite-actions/compile-antlr
        with:
          install_dir: psql13

      - name: Set env variables and build extensions
        if: always() && steps.compile-antlr.outcome == 'success'
        uses: ./.github/composite-actions/build-extensions
        with: 
          install_dir: psql13
          extension_branch: BABEL_1_2_STABLE

      - name: Testing
        run: |
          ls -al ~
          ls -al ~/psql13
        shell: bash